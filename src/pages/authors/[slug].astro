---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { SITE } from "../../config/site";

export async function getStaticPaths() {
  const authors = await getCollection('authors');
  return authors.map((a) => ({ params: { slug: a.slug } }));
}

const { slug } = Astro.params;
const authors = await getCollection('authors');
const author = authors.find((a) => a.slug === slug);
if (!author) throw new Error('Author not found');

const posts = (await getCollection('posts')).filter((p) => p.data.author?.slug === author.slug || p.data.reviewedBy?.slug === author.slug);

const siteUrl = SITE.URL;
const url = `${siteUrl}${Astro.url.pathname}`;
const a = author.data;
const schema = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: a.name,
  description: a.bio,
  image: a.avatar ? `${siteUrl}${a.avatar}` : undefined,
  sameAs: a.sameAs
};
---
<BaseLayout title={`${author.data.name} â€” Author`} description={author.data.bio} url={url} image={author.data.avatar || '/og-default.jpg'} type="profile" {schema}>
  <section class="mx-auto max-w-[var(--max-w)] px-4 py-10">
    <div class="flex items-start gap-6">
      {a.avatar && <img src={a.avatar} alt={a.name} width="96" height="96" class="rounded-full ring-1 ring-gray-200" loading="lazy" />}
      <div>
        <h1 class="text-3xl font-semibold">{a.name}</h1>
        {a.title && <div class="text-sm text-gray-500">{a.title}</div>}
        <p class="mt-3 max-w-3xl">{a.bio}</p>
        {a.credentials?.length ? (
          <ul class="mt-3 flex flex-wrap gap-2 text-xs text-gray-700">
            {a.credentials.map((c) => <li class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded">{c}</li>)}
          </ul>
        ) : null}
      </div>
    </div>

    <h2 class="mt-10 text-xl font-semibold">Articles</h2>
    <ul class="mt-4 space-y-2">
      {posts.map((p) => (
        <li>
          <a href={`/posts/${p.slug}/`} class="underline">{p.data.title}</a>
          <span class="text-xs text-gray-500 ml-2">{new Date(p.data.pubDate).toLocaleDateString()}</span>
        </li>
      ))}
    </ul>
  </section>
</BaseLayout>
