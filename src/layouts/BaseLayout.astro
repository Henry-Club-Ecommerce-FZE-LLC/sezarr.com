---
import '../styles/base.css';
import '../styles/professional-theme.css';
import '../styles/professional-ads.css';
import { getCollection } from 'astro:content';
import ThemeToggle from "../components/ThemeToggle.astro";
import CookieBanner from "../components/CookieBanner.astro";
import EnhancedAnalytics from "../components/EnhancedAnalytics.astro";
import { SITE } from "../config/site";

interface BreadcrumbItem {
  label: string;
  href: string;
}

interface Props {
  title?: string;
  description?: string;
  url?: string;
  image?: string;
  type?: string;
  schema?: any;
  noindex?: boolean;
  publishedDate?: string;
  modifiedDate?: string;
  author?: {
    name: string;
    url: string;
    image?: string;
  };
  category?: string;
  tags?: string[];
  breadcrumbs?: BreadcrumbItem[];
}

const {
  title = SITE.NAME,
  description = 'Independent, practical insurance guides for Americans. Compare rates, understand coverage, and make confident decisions.',
  url = SITE.URL,
  image = '/og-default.jpg',
  type = 'website',
  schema = {},
  noindex = false,
  publishedDate,
  modifiedDate,
  author = {
    name: SITE.NAME,
    url: SITE.URL
  },
  category,
  tags = [],
  breadcrumbs = [],
} = Astro.props;

// Get the current pathname for navigation highlighting
const currentPath = new URL(Astro.url).pathname;

// Get dynamic content for navigation
const allPosts = await getCollection('posts');
const allTools = await Astro.glob('../pages/tools/**/index.astro');
const allInsurancePages = await Astro.glob('../pages/*-insurance/index.astro');

// Get unique blog categories dynamically
const blogCategories = [...new Set(allPosts.map(post => post.data.category))].map(cat => {
  const categoryMapping = {
    'auto': { url: '/blog/auto/', name: 'Auto Insurance', icon: '🚗' },
    'business': { url: '/blog/business/', name: 'Business Insurance', icon: '🏢' },
    'health': { url: '/blog/health/', name: 'Health Insurance', icon: '🏥' },
    'homeowners': { url: '/blog/homeowners/', name: 'Home Insurance', icon: '🏠' },
    'life': { url: '/blog/life/', name: 'Life Insurance', icon: '💰' },
    'travel': { url: '/blog/travel/', name: 'Travel Insurance', icon: '✈️' },
    'pets': { url: '/blog/pets/', name: 'Pet Insurance', icon: '🐕' },
    'disability': { url: '/blog/disability/', name: 'Disability Insurance', icon: '🦽' }
  };
  return categoryMapping[cat] || { url: `/blog/${cat}/`, name: cat.charAt(0).toUpperCase() + cat.slice(1), icon: '📄' };
}).sort((a, b) => a.name.localeCompare(b.name));

// Get dynamic tools data organized by categories
const toolsCategories = [
  {
    name: 'Personal Tools',
    icon: '👤',
    tools: [
      { url: '/tools/auto-insurance-calculator/', name: 'Auto Calculator', icon: '🚗' },
    { url: '/tools/health-insurance-calculator/', name: 'Health Calculator', icon: '🏥' },
    { url: '/tools/homeowners-insurance-calculator/', name: 'Home Calculator', icon: '🏠' },
    { url: '/tools/life-insurance-calculator/', name: 'Life Calculator', icon: '💰' },
    { url: '/tools/disability-insurance-calculator/', name: 'Disability Calculator', icon: '🦽' },
    { url: '/tools/travel-insurance-calculator/', name: 'Travel Calculator', icon: '✈️' }
    ]
  },
  {
    name: 'Business Tools',
    icon: '🏢',
    tools: [
      { url: '/tools/business-insurance-calculator/', name: 'Business Calculator', icon: '�' },
    { url: '/tools/professional-liability-calculator/', name: 'Professional Liability', icon: '⚖️' },
    { url: '/tools/workers-comp-calculator/', name: 'Workers Comp', icon: '🦺' }
    ]
  },
  {
    name: 'Other Tools',
    icon: '🔧',
    tools: [
      { url: '/tools/', name: 'All Tools', icon: '🧮' },
    { url: '/tools/insurance-quote-comparison/', name: 'Quote Comparison', icon: '📊' },
    { url: '/tools/claims-probability-calculator/', name: 'Claims Calculator', icon: '📋' },
    { url: '/tools/pet-insurance-calculator/', name: 'Pet Calculator', icon: '🐕' },
    { url: '/tools/pet-health-costs/', name: 'Pet Health Costs', icon: '💲' }
    ]
  }
];

// Get dynamic insurance data
const insuranceData = [
  { url: '/auto-insurance/', name: 'Auto Insurance', icon: '🚗' },
  { url: '/business-insurance/', name: 'Business Insurance', icon: '🏢' },
  { url: '/travel-insurance/', name: 'Travel Insurance', icon: '✈️' },
  { url: '/pet-insurance/', name: 'Pet Insurance', icon: '🐕' },
  { url: '/health-insurance/', name: 'Health Insurance', icon: '🏥' },
  { url: '/homeowners-insurance/', name: 'Home Insurance', icon: '🏠' },
  { url: '/life-insurance/', name: 'Life Insurance', icon: '💰' },
  { url: '/disability-insurance/', name: 'Disability Insurance', icon: '🦽' }
];

const currentYear = new Date().getFullYear();

// CDN Configuration  
const CDN_BASE = import.meta.env.CDN_BASE_URL || '';
const USE_CDN = import.meta.env.USE_CDN === 'true' && import.meta.env.PROD;
---

<!DOCTYPE html>
<html lang="en" class="h-full" itemscope itemtype="http://schema.org/WebSite">
  <head>
    <!-- Keyboard accessibility for navigation dropdowns -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dropdownButtons = document.querySelectorAll('nav[aria-label="Main navigation"] button[aria-haspopup="true"]');
        dropdownButtons.forEach(btn => {
          const menuId = btn.getAttribute('aria-controls');
          const menu = document.getElementById(menuId);
          if (!menu) return;
          
          // Open/close on click
          btn.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent any form submission behavior
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', !expanded);
            menu.style.opacity = !expanded ? '1' : '';
            menu.style.visibility = !expanded ? 'visible' : '';
            if (!expanded) {
              // Focus first menuitem
              const firstItem = menu.querySelector('[role="menuitem"]');
              if (firstItem) firstItem.focus();
            }
          });
          
          // Keyboard navigation
          btn.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
              e.preventDefault();
              btn.setAttribute('aria-expanded', 'true');
              menu.style.opacity = '1';
              menu.style.visibility = 'visible';
              const firstItem = menu.querySelector('[role="menuitem"]');
              if (firstItem) firstItem.focus();
            }
          });
          
          // Close on ESC
          menu.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
              btn.setAttribute('aria-expanded', 'false');
              menu.style.opacity = '';
              menu.style.visibility = '';
              btn.focus();
            }
            // Arrow navigation
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
              e.preventDefault();
              const items = Array.from(menu.querySelectorAll('[role="menuitem"]'));
              const current = document.activeElement;
              let idx = items.indexOf(current);
              if (e.key === 'ArrowDown') idx = (idx + 1) % items.length;
              if (e.key === 'ArrowUp') idx = (idx - 1 + items.length) % items.length;
              items[idx].focus();
            }
          });
          
          // Close menu when focus leaves
          menu.addEventListener('focusout', e => {
            setTimeout(() => {
              if (!menu.contains(document.activeElement) && document.activeElement !== btn) {
                btn.setAttribute('aria-expanded', 'false');
                menu.style.opacity = '';
                menu.style.visibility = '';
              }
            }, 10);
          });
          
          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!btn.contains(e.target) && !menu.contains(e.target)) {
              btn.setAttribute('aria-expanded', 'false');
              menu.style.opacity = '';
              menu.style.visibility = '';
            }
          });
        });
      });
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    
    <!-- Enhanced Theme Management Script -->
    <script is:inline>
      // Critical inline theme script - prevents FOUC and implements professional theme system
      (function() {
        const theme = localStorage.getItem('theme') || 
                     (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        // Apply theme using data attribute for professional theme system
        if (theme === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
          document.documentElement.classList.remove('dark');
        }
        
        // Listen for theme changes
        window.addEventListener('storage', function(e) {
          if (e.key === 'theme') {
            const newTheme = e.newValue || 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            if (newTheme === 'dark') {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }
        });
      })();
    </script>
    
  <!-- Enhanced Resource Hints for Speed Index optimization -->
  <!-- Removed unused preconnect for jsdelivr -->
    
  <!-- Preload LCP hero image for faster LCP -->
  <link rel="preload" as="image" href="/images/hero-insurance-lg.avif" type="image/avif" />
  <!-- DNS Prefetch for external resources loaded later -->
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    
    <!-- Critical resource preloading for LCP optimization -->
    <!-- Font preloading removed - using Google Fonts CDN -->

    <!-- Web App Manifest and Icons -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    
    <!-- Progressive Web App meta tags -->
    <meta name="theme-color" content="#1e40af" />
    <meta name="color-scheme" content="light dark" />
  <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="format-detection" content="telephone=no" />

    <!-- DNS Prefetch for next-page resources -->
    <link rel="dns-prefetch" href="/about/" />
    <link rel="dns-prefetch" href="/tools/" />
    
    <!-- Inline critical CSS -->
    <link rel="stylesheet" href="/assets/critical.css" />
    
    <!-- Defer non-critical CSS -->
    <link 
      rel="preload" 
      href="/assets/index-DrUS5X7n.css" 
      as="style" 
    />
    <link 
      rel="preload" 
      href="/assets/css/modern-images.css" 
      as="style" 
    />
    <link rel="stylesheet" href="/assets/index-DrUS5X7n.css" media="print" onload="this.media='all'" />
    <link rel="stylesheet" href="/assets/css/modern-images.css" media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href="/assets/index-DrUS5X7n.css" />
      <link rel="stylesheet" href="/assets/css/modern-images.css" />
    </noscript>

    <!-- Load CSS asynchronously -->
    <script>
      // Efficient CSS loading
      const loadCSS = (href) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        document.head.appendChild(link);
      };
      // Load non-critical CSS after the page loads
      window.addEventListener('load', () => {
        requestIdleCallback(() => {
          ['/assets/index-DrUS5X7n.css', '/assets/css/modern-images.css'].forEach(loadCSS);
        });
      });
    </script>

    <!-- Optimized script loading -->
    <script>
      // Preload key scripts
      const preloadScript = (src) => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'script';
        link.href = src;
        document.head.appendChild(link);
      };

      // Preload critical scripts
      requestIdleCallback(() => {
        preloadScript('/js/search.js');
        preloadScript('/js/business-insurance-calculator.js');
      });
    </script>

    <!-- Progressive Loading & Core Functionality -->
    <script type="module">
      // Load core functionality during idle time
      requestIdleCallback(() => {
        import('/js/business-insurance-calculator.js');
      });
    </script>
    
    <!-- Critical Performance Script - Inlined and Minified -->
    <script src="/js/critical-performance.min.js" async></script>
    
    <!-- Search functionality - loaded after core content -->
    <script src="/js/search.min.js" async defer></script>
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={url} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, SITE.URL).toString()} />
    <meta property="og:url" content={url} />
    <meta property="og:type" content={type} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={SITE.SOCIAL.TWITTER} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(image, SITE.URL).toString()} />
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico" sizes="48x48" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Schema.org -->
    {schema && Array.isArray(schema) && schema.length > 0 ? (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ) : (
      <script type="application/ld+json" set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': type === 'article' ? 'Article' : 'WebSite',
        'name': title,
        'headline': title,
        'description': description,
        'image': new URL(image, SITE.URL).toString(),
        'url': url,
        'datePublished': publishedDate,
        'dateModified': modifiedDate || publishedDate,
        'author': author && author.name ? {
          '@type': 'Person',
          'name': author.name,
          'url': author.url
        } : undefined,
        'publisher': {
          '@type': 'Organization',
          'name': SITE.NAME,
          'url': SITE.URL,
          'logo': {
            '@type': 'ImageObject',
            'url': new URL('/logo.svg', SITE.URL).toString()
          }
        },
        'mainEntityOfPage': {
          '@type': 'WebPage',
          '@id': url
        },
        'articleSection': category,
        'keywords': tags && tags.length > 0 ? tags.join(',') : undefined
      })} />
    )}
    
    <!-- Critical CSS inlined for instant rendering and optimal Speed Index -->
    <style is:inline>
      /* Ultra-critical above-the-fold styles only */
      *,*::before,*::after{box-sizing:border-box}
      html{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;-webkit-text-size-adjust:100%;scroll-behavior:smooth;text-rendering:optimizeSpeed}
      body{margin:0;background:#fff;color:#111827;font-size:16px;font-display:swap}
      .dark body{background:#111827;color:#f9fafb}
      
      /* Critical layout styles for LCP */
      .min-h-full{min-height:100vh}
      .flex{display:flex}
      .flex-col{flex-direction:column}
      .sticky{position:sticky}
      .relative{position:relative}
      .absolute{position:absolute}
      .inset-0{top:0;right:0;bottom:0;left:0}
      .top-0{top:0}
      .z-50{z-index:50}
      .z-40{z-index:40}
      .z-30{z-index:30}
      .z-10{z-index:10}
      .border-b{border-bottom:1px solid #e5e7eb}
      .border-t{border-top:1px solid #e5e7eb}
      .dark .border-b{border-color:#374151}
      .dark .border-t{border-color:#374151}
      .bg-white{background:#fff}
      .dark .bg-white{background:#111827}
      .backdrop-blur{backdrop-filter:blur(8px)}
      .mx-auto{margin:0 auto}
      .w-full{width:100%}
      .max-w-\[var\(--max-w\)\]{max-width:var(--max-w)}
      .px-4{padding-left:1rem;padding-right:1rem}
      .py-3{padding-top:.75rem;padding-bottom:.75rem}
      .py-4{padding-top:1rem;padding-bottom:1rem}
      .py-8{padding-top:2rem;padding-bottom:2rem}
      .py-12{padding-top:3rem;padding-bottom:3rem}
      .items-center{align-items:center}
      .justify-between{justify-content:space-between}
      .justify-center{justify-content:center}
      .text-center{text-align:center}
      
      /* Critical typography for hero/LCP */
      .font-bold{font-weight:700}
      .font-extrabold{font-weight:800}
      .text-xl{font-size:1.25rem;line-height:1.75rem}
      .text-2xl{font-size:1.5rem;line-height:2rem}
      .text-3xl{font-size:1.875rem;line-height:2.25rem}
      .text-4xl{font-size:2.25rem;line-height:2.5rem}
      .text-5xl{font-size:3rem;line-height:1}
      .text-lg{font-size:1.125rem;line-height:1.75rem}
      
      /* Critical hero styles */
      .text-transparent{color:transparent}
      .bg-gradient-to-r{background:linear-gradient(90deg,#2563eb,#9333ea)}
      .from-blue-600{--tw-gradient-from:#2563eb}
      .to-purple-600{--tw-gradient-to:#9333ea}
      .bg-clip-text{background-clip:text;-webkit-background-clip:text}
      
      /* Critical interactive states */
      .transition-colors{transition:color .15s ease}
      .transition-transform{transition:transform .15s ease}
      .hover\:text-blue-600:hover{color:#2563eb}
      .dark .dark\:hover\:text-blue-400:hover{color:#60a5fa}
      
      /* Mobile menu drawer animations */
      .translate-x-full{transform:translateX(100%)}
      .transition-transform{transition:transform 0.3s ease-out}
      .duration-300{transition-duration:0.3s}
      .ease-out{transition-timing-function:cubic-bezier(0,0,0.2,1)}
      
      /* Accessibility */
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
      .focus\:not-sr-only:focus{position:static;width:auto;height:auto;padding:0;margin:0;overflow:visible;clip:auto;white-space:normal}
      .no-underline{text-decoration:none}
      
      /* Core layout vars */
      :root{--max-w:72rem}
      .hidden{display:none}
      .block{display:block}
      .inline-block{display:inline-block}
      .mb-4{margin-bottom:1rem}
      .mb-6{margin-bottom:1.5rem}
      .mt-2{margin-top:.5rem}
      .gap-2{gap:.5rem}
      .gap-4{gap:1rem}
      
      /* Responsive visibility */
      @media (min-width:768px){
        .md\:flex{display:flex}
        .md\:hidden{display:none}
        .md\:py-3{padding-top:.75rem;padding-bottom:.75rem}
        .md\:text-6xl{font-size:3.75rem;line-height:1}
      }
      @media (min-width:1024px){
        .lg\:text-7xl{font-size:4.5rem;line-height:1}
      }
    </style>
    
    <!-- Optimized CSS loading to prevent render blocking -->
    <script is:inline>
      // Load non-critical CSS asynchronously without blocking render
      function loadCSS(href, media) {
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.media = media || 'all';
        document.head.appendChild(link);
      }
      
      // Load CSS after first paint to improve FCP/LCP
      if ('requestIdleCallback' in window) {
        requestIdleCallback(function() {
          loadCSS('/assets/css/main.css');
          loadCSS('/assets/css/optimized-fonts.css');
        });
      } else {
        setTimeout(function() {
          loadCSS('/assets/css/main.css');
          loadCSS('/assets/css/optimized-fonts.css');
        }, 16);
      }
    </script>
    
    <noscript>
      <link rel="stylesheet" href="/assets/css/main.css" />
      <link rel="stylesheet" href="/assets/css/optimized-fonts.css" />
    </noscript>
    
    <!-- Ultra-optimized JavaScript loading for performance -->
    <script is:inline define:vars={{ USE_CDN, CDN_BASE }}>
      // Critical inline theme script only - prevents FOUC
      (function() {
        const theme = localStorage.getItem('theme') || 
                     (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
      
      // Defer ALL non-critical JavaScript until after page is interactive
      function loadScriptsAsync() {
        // Load theme script with high priority
        const themeScript = document.createElement('script');
        themeScript.src = USE_CDN && CDN_BASE 
          ? CDN_BASE + '/scripts/enhancedThemeScript.js'
          : '/scripts/enhancedThemeScript.js';
        themeScript.async = true;
        themeScript.onerror = function() {
          if (USE_CDN && CDN_BASE) {
            const fallback = document.createElement('script');
            fallback.src = '/scripts/enhancedThemeScript.js';
            fallback.async = true;
            document.head.appendChild(fallback);
          }
        };
        document.head.appendChild(themeScript);
        
        // Register service worker with lowest priority
        if ('serviceWorker' in navigator) {
          setTimeout(function() {
            const swUrl = USE_CDN && CDN_BASE ? CDN_BASE + '/sw.js' : '/sw.js';
            navigator.serviceWorker.register(swUrl).catch(function() {
              if (USE_CDN && CDN_BASE) {
                navigator.serviceWorker.register('/sw.js').catch(function() {});
              }
            });
          }, 3000);
        }
      }
      
      // Load scripts after page is interactive (improves TBT)
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadScriptsAsync, { timeout: 2000 });
      } else {
        setTimeout(loadScriptsAsync, 100);
      }
            });
          }, 3000); // Delay for better performance
        }
        
        // Progressive image loading
        if ('IntersectionObserver' in window) {
          const imageObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                  img.src = img.dataset.src;
                  img.removeAttribute('data-src');
                }
                imageObserver.unobserve(img);
              }
            });
          }, { rootMargin: '50px' });
          
          setTimeout(function() {
            document.querySelectorAll('img[data-src]').forEach(function(img) {
              imageObserver.observe(img);
            });
          }, 300);
        }
      }
      
      // Load after LCP has occurred
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadAfterLCP, { timeout: 2000 });
      } else {
        setTimeout(loadAfterLCP, 1500);
      }
    </script>
    
    <!-- Enhanced Insurance Analytics Integration -->
    <EnhancedAnalytics />
  </head>
  <body class="min-h-full flex flex-col bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100" role="document">
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-blue-600 text-white px-4 py-2 rounded-md z-50 font-medium">Skip to main content</a>
    
    <header class="border-b bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 sticky top-0 z-50 dark:bg-gray-900/80 dark:border-gray-700" role="banner">
      <div class="mx-auto w-full max-w-[var(--max-w)] px-4 py-4 md:py-3">
        <!-- Desktop & Mobile Header -->
        <div class="flex items-center justify-between">
          <!-- Brand -->
          <div role="banner" aria-label="Site brand">
            <a href="/" class="font-bold text-xl text-gray-900 dark:text-gray-100 no-underline hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Go to homepage">
              <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" aria-label="Sezarr Insurance">Sezarr</span>
            </a>
          </div>
          
          <!-- Desktop Navigation -->
          <nav class="hidden md:flex gap-6 text-sm items-center" role="navigation" aria-label="Main navigation">
            <div class="flex items-center gap-4">
              <!-- Search Bar (after logo, before menu) -->
              <form action="/search/" method="GET" class="relative">
                <input 
                  type="search" 
                  name="q" 
                  id="nav-search"
                  placeholder="Search..." 
                  class="w-48 px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  aria-label="Search site"
                  autocomplete="off"
                />
                <button 
                  type="submit"
                  class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 focus:outline-none focus:text-blue-600"
                  aria-label="Submit search"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                  </svg>
                </button>
                <!-- Search Dropdown -->
                <div 
                  id="nav-search-results"
                  class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50 max-h-80 overflow-y-auto"
                >
                  <div id="nav-search-list" class="py-2">
                    <!-- Search results will be populated here -->
                  </div>
                </div>
              </form>
              <!-- End Search Bar -->
              <ul class="flex items-center gap-6 list-none" role="list">
                <li role="listitem">
                  <a href="/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/' ? 'page' : undefined}>Home</a>
                </li>
                <!-- Tools Dropdown -->
                <li role="listitem" class="relative group">
                  <button 
                    type="button"
                    class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                    aria-expanded="false"
                    aria-haspopup="true"
                    aria-controls="tools-menu"
                  >
                    Tools
                    <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <!-- Dropdown Menu -->
                  <div 
                    id="tools-menu"
                    class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                    role="menu"
                    aria-labelledby="tools-button"
                  >
                    <div class="py-2">
                      {toolsCategories.flatMap(category => category.tools).map(tool => (
                        <a href={tool.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                          <span class="mr-3 text-lg">{tool.icon}</span>
                          {tool.name}
                        </a>
                      ))}
                    </div>
                  </div>
                </li>
                <!-- Insurance Dropdown -->
                <li role="listitem" class="relative group">
                  <button 
                    type="button"
                    class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                    aria-expanded="false"
                    aria-haspopup="true"
                    aria-controls="insurance-menu"
                  >
                    Insurance
                    <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <!-- Dropdown Menu -->
                  <div 
                    id="insurance-menu"
                    class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                    role="menu"
                    aria-labelledby="insurance-button"
                  >
                    <div class="py-2">
                      {insuranceData.map(insurance => (
                        <a href={insurance.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                          <span class="mr-3 text-lg">{insurance.icon}</span>
                          {insurance.name}
                        </a>
                      ))}
                    </div>
                  </div>
                </li>
                <!-- Blog Dropdown -->
                <li role="listitem" class="relative group">
                  <button 
                    type="button"
                    class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                    aria-expanded="false"
                    aria-haspopup="true"
                    aria-controls="blog-menu"
                  >
                    Blog
                    <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  <!-- Dropdown Menu -->
                  <div 
                    id="blog-menu"
                    class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                    role="menu"
                    aria-labelledby="blog-button"
                  >
                    <div class="py-2">
                      <a href="/blog/" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                        <span class="mr-3 text-lg">📝</span>
                        Blog Home
                      </a>
                      <a href="/posts/" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                        <span class="mr-3 text-lg">📚</span>
                        All Articles
                      </a>
                      <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                      {blogCategories.map(category => (
                        <a href={category.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                          <span class="mr-3 text-lg">{category.icon}</span>
                          {category.name}
                        </a>
                      ))}
                    </div>
                  </div>
                </li>
                <li role="listitem">
                  <a href="/about/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/about/' ? 'page' : undefined}>About</a>
                </li>
                <li role="listitem">
                  <a href="/contact/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/contact/' ? 'page' : undefined}>Contact</a>
                </li>
                <li role="listitem">
                  <ThemeToggle />
                </li>
              </ul>
            </div>
          </nav>

          <!-- Mobile Search Bar and Menu Button -->
          <div class="md:hidden flex items-center gap-3 flex-1 justify-end">
            <!-- Mobile Search Bar (after logo, before menu button) -->
            <form action="/search/" method="GET" class="relative flex-1 max-w-xs">
              <input 
                type="search" 
                name="q" 
                id="mobile-search"
                placeholder="Search..." 
                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[40px]"
                aria-label="Search site"
                autocomplete="off"
              />
              <button 
                type="submit"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 focus:outline-none focus:text-blue-600"
                aria-label="Submit search"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
              
              <!-- Mobile Search Dropdown -->
              <div 
                id="mobile-search-results"
                class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50 max-h-80 overflow-y-auto"
              >
                <div id="mobile-search-list" class="py-2">
                  <!-- Search results will be populated here -->
                </div>
              </div>
            </form>
            
            <!-- Mobile Menu Button -->
            <button 
              id="mobile-menu-button" 
              type="button" 
              class="p-3 rounded-md text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px] min-w-[44px] flex items-center justify-center flex-shrink-0" 
              aria-expanded="false"
              aria-controls="mobile-menu"
              aria-haspopup="true"
              aria-label="Toggle navigation menu"
            >
              <span class="sr-only">Toggle navigation menu</span>
              <svg 
                id="mobile-menu-open" 
                class="block h-6 w-6" 
                fill="none" 
                viewBox="0 0 24 24" 
                stroke-width="1.5" 
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <svg 
                id="mobile-menu-close" 
                class="hidden h-6 w-6" 
                fill="none" 
                viewBox="0 0 24 24" 
                stroke-width="1.5" 
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile Navigation Menu with Drawer Style -->
        <nav id="mobile-menu" class="md:hidden hidden mt-4 pb-4 border-t dark:border-gray-700" role="navigation" aria-label="Mobile navigation">
          <!-- Main Menu Level -->
          <div id="main-menu" class="pt-4 space-y-2">
            <section aria-labelledby="mobile-main-heading">
              <h2 id="mobile-main-heading" class="sr-only">Main Navigation</h2>
              <ul class="space-y-2 list-none" role="list">
                <li><a href="/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">🏠</span>
                  Home
                </a></li>
                
                <!-- Direct Calculator Links for Mobile -->
                <li><a href="/tools/auto-insurance-calculator/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center">
                  <span class="mr-3 text-lg">🚗</span>
                  Auto Calculator
                </a></li>
                
                <li><a href="/tools/homeowners-insurance-calculator/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center">
                  <span class="mr-3 text-lg">🏠</span>
                  Home Calculator
                </a></li>
                
                <li><a href="/tools/life-insurance-calculator/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center">
                  <span class="mr-3 text-lg">💰</span>
                  Life Calculator
                </a></li>
                
                <li><a href="/tools/business-insurance-calculator/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center">
                  <span class="mr-3 text-lg">🏢</span>
                  Business Calculator
                </a></li>
                
                <!-- All Tools Link -->
                <li><a href="/tools/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center">
                  <span class="mr-3 text-lg">🧮</span>
                  All Tools
                </a></li>

                <!-- Insurance Menu Item -->
                <li>
                  <button 
                    type="button"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                    data-menu-trigger="insurance"
                    aria-expanded="false"
                    aria-controls="insurance-submenu"
                  >
                    <div class="flex items-center">
                      <span class="mr-3 text-lg">🛡️</span>
                      Insurance
                    </div>
                    <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </li>

                <!-- Blog Menu Item -->
                <li>
                  <button 
                    type="button"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                    data-menu-trigger="blog"
                    aria-expanded="false"
                    aria-controls="blog-submenu"
                  >
                    <div class="flex items-center">
                      <span class="mr-3 text-lg">📝</span>
                      Blog
                    </div>
                    <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </li>
                
                <li><a href="/about/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/about/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">ℹ️</span>
                  About
                </a></li>
                <li><a href="/contact/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/contact/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">📞</span>
                  Contact
                </a></li>
                <li class="px-4 py-3">
                  <ThemeToggle />
                </li>
              </ul>
            </section>
          </div>

          <!-- Tools Submenu Drawer -->
          <div 
            id="tools-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="tools-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="tools"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="tools-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Tools</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {toolsCategories.map(category => (
                  <li>
                    <button 
                      type="button"
                      class="w-full flex items-center justify-between px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                      data-menu-trigger={category.name.toLowerCase().replace(' ', '-')}
                      aria-expanded="false"
                      aria-controls={`${category.name.toLowerCase().replace(' ', '-')}-submenu`}
                    >
                      <div class="flex items-center">
                        <span class="mr-3 text-lg">{category.icon}</span>
                        {category.name}
                      </div>
                      <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </button>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Personal Tools Submenu -->
          <div 
            id="personal-tools-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-20"
            role="menu"
            aria-labelledby="personal-tools-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="personal-tools"
                  aria-label="Go back to tools menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="personal-tools-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Personal Tools</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {toolsCategories[0].tools.map(tool => (
                  <li>
                    <a href={tool.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{tool.icon}</span>
                      {tool.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Business Tools Submenu -->
          <div 
            id="business-tools-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-20"
            role="menu"
            aria-labelledby="business-tools-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="business-tools"
                  aria-label="Go back to tools menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="business-tools-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Business Tools</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {toolsCategories[1].tools.map(tool => (
                  <li>
                    <a href={tool.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{tool.icon}</span>
                      {tool.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Other Tools Submenu -->
          <div 
            id="other-tools-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-20"
            role="menu"
            aria-labelledby="other-tools-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="other-tools"
                  aria-label="Go back to tools menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="other-tools-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Other Tools</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {toolsCategories[2].tools.map(tool => (
                  <li>
                    <a href={tool.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{tool.icon}</span>
                      {tool.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Insurance Submenu Drawer -->
          <div 
            id="insurance-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="insurance-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="insurance"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="insurance-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Insurance</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {insuranceData.map(insurance => (
                  <li>
                    <a href={insurance.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{insurance.icon}</span>
                      {insurance.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Blog Submenu Drawer -->
          <div 
            id="blog-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="blog-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="blog"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="blog-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Blog</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                <li>
                  <a href="/blog/" class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                    <span class="mr-3 text-lg">📝</span>
                    Blog Home
                  </a>
                </li>
                <li>
                  <a href="/posts/" class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                    <span class="mr-3 text-lg">📚</span>
                    All Articles
                  </a>
                </li>
                <li class="border-t dark:border-gray-700 mt-2 pt-2">
                  <div class="px-4 py-2 text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Categories</div>
                </li>
                {blogCategories.map(category => (
                  <li>
                    <a href={category.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{category.icon}</span>
                      {category.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </nav>
      </div>

      <!-- Mobile Menu with Drawer JavaScript -->
      <script type="module">
        // Import and initialize mobile menu with lazy loading
        import('/js/mobile-menu.js').then(module => {
          window.MobileMenu = module.default;
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => module.default.init());
          } else {
            module.default.init();
          }
        }).catch(error => {
          console.warn('Mobile menu failed to load:', error);
        });
      </script>
      
      <!-- Search Functionality -->
      <script is:inline define:vars={{ searchData: allPosts.map(p => ({ 
        slug: p.slug, 
        title: p.data.title, 
        description: p.data.description,
        category: p.data.category
      })) }}>
        window.SEARCH_DATA = searchData;
      </script>
      <script type="module">
        // Lazy load search functionality
        const initSearch = async () => {
          if (!window.SearchModule) {
            const searchModule = await import('/js/search.js');
            window.SearchModule = searchModule;
          }
          window.SearchModule.init(window.SEARCH_DATA);
        };
        
        // Initialize search only when input is focused
        const searchInputs = ['nav-search', 'mobile-search'];
        searchInputs.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.addEventListener('focus', initSearch, { once: true });
          }
        });
        
        // Pre-load search module during idle time
        requestIdleCallback(() => {
          import('/js/search.js');
        });
              if (items.length === 0) {
                resultsElement.classList.add('opacity-0', 'invisible');
                return;
              }
              
              const html = items.slice(0, 5).map(item => `
                <a href="/posts/${item.slug}/" class="flex items-start px-4 py-3 hover:bg-blue-50 dark:hover:bg-blue-900/20 border-b border-gray-100 dark:border-gray-600 last:border-b-0 transition-colors">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 text-sm mb-1">${item.title}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${item.description}</div>
                    <div class="text-sm text-blue-600 dark:text-blue-400 mt-1 capitalize">${item.category} Insurance</div>
                  </div>
                </a>
              `).join('');
              
              if (items.length > 5) {
                listElement.innerHTML = html + `
                  <div class="px-4 py-2 text-center">
                    <a href="/search/?q=${encodeURIComponent(navSearch.value || mobileSearch.value)}" class="text-blue-600 dark:text-blue-400 text-sm hover:underline">
                      View all ${items.length} results →
                    </a>
                  </div>
                `;
              } else {
                listElement.innerHTML = html;
              }
              
              resultsElement.classList.remove('opacity-0', 'invisible');
            }
            
            function performSearch(query) {
              if (!query || query.length < 2) {
                navResults.classList.add('opacity-0', 'invisible');
                mobileResults.classList.add('opacity-0', 'invisible');
                return;
              }
              
              const searchTerm = query.toLowerCase();
              const results = searchData.filter(item => 
                item.title.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
              ).sort((a, b) => {
                // Prioritize title matches
                const aTitleMatch = a.title.toLowerCase().includes(searchTerm);
                const bTitleMatch = b.title.toLowerCase().includes(searchTerm);
                if (aTitleMatch && !bTitleMatch) return -1;
                if (!aTitleMatch && bTitleMatch) return 1;
                return 0;
              });
              
              renderResults(results, navList, navResults);
              renderResults(results, mobileList, mobileResults);
            }
            
            // Desktop search
            navSearch.addEventListener('input', (e) => {
              performSearch(e.target.value);
            });
            
            navSearch.addEventListener('focus', () => {
              if (navSearch.value.length >= 2) {
                performSearch(navSearch.value);
              }
            });
            
            // Mobile search  
            mobileSearch.addEventListener('input', (e) => {
              performSearch(e.target.value);
            });
            
            mobileSearch.addEventListener('focus', () => {
              if (mobileSearch.value.length >= 2) {
                performSearch(mobileSearch.value);
              }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
              if (!navSearch.contains(e.target) && !navResults.contains(e.target)) {
                navResults.classList.add('opacity-0', 'invisible');
              }
              if (!mobileSearch.contains(e.target) && !mobileResults.contains(e.target)) {
                mobileResults.classList.add('opacity-0', 'invisible');
              }
            });
            
            // Close on escape
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape') {
                navResults.classList.add('opacity-0', 'invisible');
                mobileResults.classList.add('opacity-0', 'invisible');
              }
            });
          }
          
          // Initialize when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSearch);
          } else {
            initSearch();
          }
        })();
      </script>
    </header>
    
    <main id="main" class="flex-1" role="main">
      <div class="main-content">
        <div class="mx-auto w-full max-w-[var(--max-w)] px-4">
        </div>
        <slot />
      </div>
    </main>
    
    <footer class="border-t mt-12 dark:border-gray-700" role="contentinfo" aria-labelledby="footer-heading">
      <h2 id="footer-heading" class="sr-only">Footer</h2>
      <div class="mx-auto w-full max-w-[var(--max-w)] px-4 py-8 grid md:grid-cols-4 gap-6 text-sm text-gray-600 dark:text-gray-400">
        <section aria-labelledby="footer-about">
          <h3 id="footer-about" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">{SITE.NAME}</h3>
          <p>Smart insurance decisions made simple. We may earn from affiliate links. Not financial advice.</p>
        </section>
        <nav aria-labelledby="footer-legal">
          <h3 id="footer-legal" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Legal</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/privacy/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/privacy/' ? 'page' : undefined}>Privacy Policy</a></li>
            <li><a href="/terms/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/terms/' ? 'page' : undefined}>Terms</a></li>
            <li><a href="/disclaimer/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/disclaimer/' ? 'page' : undefined}>Disclaimer</a></li>
            <li><a href="/affiliate-disclosure/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/affiliate-disclosure/' ? 'page' : undefined}>Affiliate Disclosure</a></li>
          </ul>
        </nav>
        <nav aria-labelledby="footer-categories">
          <h3 id="footer-categories" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Categories</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/auto-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/auto-insurance/' ? 'page' : undefined}>Auto Insurance</a></li>
            <li><a href="/health-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/health-insurance/' ? 'page' : undefined}>Health Insurance</a></li>
            <li><a href="/homeowners-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/homeowners-insurance/' ? 'page' : undefined}>Homeowners Insurance</a></li>
            <li><a href="/life-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/life-insurance/' ? 'page' : undefined}>Life Insurance</a></li>
          </ul>
        </nav>
        <nav aria-labelledby="footer-connect">
          <h3 id="footer-connect" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Connect</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/contact/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/contact/' ? 'page' : undefined}>Contact</a></li>
            <li><a href="/about/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;" aria-current={url === '/about/' ? 'page' : undefined}>About Us</a></li>
            <li><a href="/sitemap-index.xml" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1 min-w-[44px] min-h-[44px]" style="display:inline-flex;align-items:center;justify-content:center;width:44px;min-width:44px;height:44px;min-height:44px;touch-action:manipulation;">Sitemap</a></li>
          </ul>
        </nav>
      </div>
      <div class="text-center text-sm text-gray-500 dark:text-gray-400 py-4 border-t dark:border-gray-700">
        <small style="font-size:13px;">© {currentYear} {SITE.NAME}. All rights reserved.</small>
      </div>
    </footer>
    
    <!-- GDPR Cookie Consent Banner -->
    <CookieBanner />
    
  </body>
</html>