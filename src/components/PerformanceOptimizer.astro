---
// Performance optimization component for PageSpeed improvements
const CDN_BASE = import.meta.env.CDN_BASE_URL || '';
const USE_CDN = import.meta.env.USE_CDN === 'true' && import.meta.env.PROD;
---

<!-- Critical Performance Optimizations -->

<!-- 1. Resource Hints - Preconnect to critical external domains -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

<!-- 2. DNS Prefetch for potential third-party resources -->
<link rel="dns-prefetch" href="//pagead2.googlesyndication.com" />
<link rel="dns-prefetch" href="//www.google-analytics.com" />
<link rel="dns-prefetch" href="//unpkg.com" />

<!-- 3. Early preload of critical assets -->
<link rel="preload" href="/favicon.svg" as="image" type="image/svg+xml" />
<link rel="preload" href="/assets/css/critical.css" as="style" />

<!-- 4. Preload critical fonts with proper CORS -->
<link rel="preload" href="/assets/fonts/inter/inter-regular.woff2" as="font" type="font/woff2" crossorigin />
<link rel="preload" href="/assets/fonts/inter/inter-medium.woff2" as="font" type="font/woff2" crossorigin />
<link rel="preload" href="/assets/fonts/inter/inter-semibold.woff2" as="font" type="font/woff2" crossorigin />
<link rel="preload" href="/assets/fonts/inter/inter-bold.woff2" as="font" type="font/woff2" crossorigin />

<!-- 5. Critical CSS - Inline for immediate rendering -->
<style is:inline>
/* Critical CSS - Only above-the-fold content */
*,*::before,*::after{box-sizing:border-box}
html{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.6;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{margin:0;background:#fff;color:#111827;font-size:16px}
.dark body{background:#111827;color:#f9fafb}
.min-h-full{min-height:100vh}
.flex{display:flex}
.flex-col{flex-direction:column}
.sticky{position:sticky}
.top-0{top:0}
.z-50{z-index:50}
.border-b{border-bottom:1px solid #e5e7eb}
.dark .border-b{border-color:#374151}
.bg-white{background:#fff}
.dark .bg-white{background:#111827}
.backdrop-blur{backdrop-filter:blur(8px)}
.mx-auto{margin:0 auto}
.w-full{width:100%}
.max-w-6xl{max-width:72rem}
.px-4{padding-left:1rem;padding-right:1rem}
.py-3{padding-top:.75rem;padding-bottom:.75rem}
.items-center{align-items:center}
.justify-between{justify-content:space-between}
.font-bold{font-weight:700}
.text-xl{font-size:1.25rem}
.text-transparent{color:transparent}
.bg-gradient-to-r{background:linear-gradient(90deg,#2563eb,#9333ea)}
.bg-clip-text{background-clip:text;-webkit-background-clip:text}
.transition-colors{transition:color .15s ease}
.hover\:text-blue-600:hover{color:#2563eb}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.focus\:not-sr-only:focus{position:static;width:auto;height:auto;padding:0;margin:0;overflow:visible;clip:auto;white-space:normal}

/* Hero section critical styles */
.hero{text-align:center;padding:5rem 1rem}
.hero h1{font-size:3rem;line-height:1;margin:0 0 1rem;font-weight:800}
.hero p{font-size:1.25rem;color:#6b7280;margin:0}
.dark .hero p{color:#9ca3af}

/* Skip to content */
.skip-link{position:absolute;top:-40px;left:6px;background:#2563eb;color:#fff;padding:8px;text-decoration:none;border-radius:4px;z-index:100}
.skip-link:focus{top:6px}
</style>

<!-- 6. Optimized theme script - no flash of unstyled content -->
<script is:inline>
(function() {
  const theme = localStorage.getItem('theme') || 
               (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  
  if (theme === 'dark') {
    document.documentElement.classList.add('dark');
  }
  
  // Store theme for consistency
  localStorage.setItem('theme', theme);
})();
</script>

<!-- 7. Non-critical CSS - Load asynchronously -->
<link rel="preload" href="/assets/css/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/assets/css/main.css"></noscript>

<!-- 8. Font CSS - Load asynchronously -->
<link rel="preload" href="/assets/css/optimized-fonts.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/assets/css/optimized-fonts.css"></noscript>

<!-- 9. Defer JavaScript loading -->
<script is:inline>
// Load scripts after page load to avoid blocking
window.addEventListener('load', function() {
  const scripts = [
    { src: USE_CDN ? `${CDN_BASE}/scripts/enhancedThemeScript.js` : '/scripts/enhancedThemeScript.js', fallback: '/scripts/enhancedThemeScript.js' },
    { src: '/assets/js/performance.js', fallback: null }
  ];
  
  scripts.forEach(scriptInfo => {
    const script = document.createElement('script');
    script.src = scriptInfo.src;
    script.async = true;
    
    if (scriptInfo.fallback) {
      script.onerror = function() {
        const fallback = document.createElement('script');
        fallback.src = scriptInfo.fallback;
        fallback.async = true;
        document.head.appendChild(fallback);
      };
    }
    
    document.head.appendChild(script);
  });
});
</script>

<!-- 10. Service Worker - Load after page is interactive -->
<script is:inline define:vars={{ USE_CDN, CDN_BASE }}>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    setTimeout(function() {
      const swUrl = USE_CDN && CDN_BASE ? `${CDN_BASE}/sw.js` : '/sw.js';
      
      navigator.serviceWorker.register(swUrl)
        .then(function(registration) {
          console.log('SW registered');
        })
        .catch(function(error) {
          console.log('SW registration failed');
          if (USE_CDN && CDN_BASE) {
            navigator.serviceWorker.register('/sw.js').catch(() => {});
          }
        });
    }, 1000); // Delay SW registration to not interfere with page load
  });
}
</script>