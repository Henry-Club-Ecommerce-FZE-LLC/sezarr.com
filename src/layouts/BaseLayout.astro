---
import '../styles/base.css';
import { getCollection } from 'astro:content';
import ThemeToggle from "../components/ThemeToggle.astro";
import EnhancedAnalytics from "../components/EnhancedAnalytics.astro";
import { SITE } from "../config/site";

interface BreadcrumbItem {
  label: string;
  href: string;
}

interface Props {
  title?: string;
  description?: string;
  url?: string;
  image?: string;
  type?: string;
  schema?: any;
  noindex?: boolean;
  publishedDate?: string;
  modifiedDate?: string;
  author?: {
    name: string;
    url: string;
    image?: string;
  };
  category?: string;
  tags?: string[];
  breadcrumbs?: BreadcrumbItem[];
}

const {
  title = SITE.NAME,
  description = 'Independent, practical insurance guides for Americans. Compare rates, understand coverage, and make confident decisions.',
  url = SITE.URL,
  image = '/og-default.jpg',
  type = 'website',
  schema = {},
  noindex = false,
  publishedDate,
  modifiedDate,
  author = {
    name: SITE.NAME,
    url: SITE.URL,
  },
  category,
  tags = [],
  breadcrumbs = [],
} = Astro.props;

// Get the current pathname for navigation highlighting
const currentPath = new URL(Astro.url).pathname;

// Get dynamic content for navigation
const allPosts = await getCollection('posts');
const allTools = await Astro.glob('../pages/tools/**/index.astro');
const allInsurancePages = await Astro.glob('../pages/*-insurance/index.astro');

// Get unique blog categories dynamically
const blogCategories = [...new Set(allPosts.map(post => post.data.category))].map(cat => {
  const categoryMapping = {
    'auto': { url: '/blog/auto/', name: 'Auto Insurance', icon: '🚗' },
    'business': { url: '/blog/business/', name: 'Business Insurance', icon: '🏢' },
    'health': { url: '/blog/health/', name: 'Health Insurance', icon: '🏥' },
    'homeowners': { url: '/blog/homeowners/', name: 'Home Insurance', icon: '🏠' },
    'life': { url: '/blog/life/', name: 'Life Insurance', icon: '💰' },
    'travel': { url: '/blog/travel/', name: 'Travel Insurance', icon: '✈️' },
    'pets': { url: '/blog/pets/', name: 'Pet Insurance', icon: '🐕' },
    'disability': { url: '/blog/disability/', name: 'Disability Insurance', icon: '🦽' }
  };
  return categoryMapping[cat] || { url: `/blog/${cat}/`, name: cat.charAt(0).toUpperCase() + cat.slice(1), icon: '📄' };
}).sort((a, b) => a.name.localeCompare(b.name));

// Get dynamic tools data
const toolsData = [
  { url: '/tools/', name: 'All Tools', icon: '🧮' },
  { url: '/tools/auto-insurance-calculator/', name: 'Auto Calculator', icon: '🚗' },
  { url: '/tools/business-insurance-calculator/', name: 'Business Calculator', icon: '🏢' },
  { url: '/tools/claims-probability-calculator/', name: 'Claims Calculator', icon: '📋' },
  { url: '/tools/disability-insurance-calculator/', name: 'Disability Calculator', icon: '🦽' },
  { url: '/tools/health-insurance-calculator/', name: 'Health Calculator', icon: '🏥' },
  { url: '/tools/homeowners-insurance-calculator/', name: 'Home Calculator', icon: '🏠' },
  { url: '/tools/insurance-quote-comparison/', name: 'Quote Comparison', icon: '📊' },
  { url: '/tools/life-insurance-calculator/', name: 'Life Calculator', icon: '💰' },
  { url: '/tools/pet-health-costs/', name: 'Pet Health Costs', icon: '🐾' },
  { url: '/tools/pet-insurance-calculator/', name: 'Pet Calculator', icon: '🐕' },
  { url: '/tools/professional-liability-calculator/', name: 'Professional Liability', icon: '⚖️' },
  { url: '/tools/travel-insurance-calculator/', name: 'Travel Calculator', icon: '✈️' },
  { url: '/tools/workers-comp-calculator/', name: 'Workers Comp', icon: '👷' }
];

// Get dynamic insurance data
const insuranceData = [
  { url: '/auto-insurance/', name: 'Auto Insurance', icon: '🚗' },
  { url: '/business-insurance/', name: 'Business Insurance', icon: '🏢' },
  { url: '/travel-insurance/', name: 'Travel Insurance', icon: '✈️' },
  { url: '/pet-insurance/', name: 'Pet Insurance', icon: '🐕' },
  { url: '/health-insurance/', name: 'Health Insurance', icon: '🏥' },
  { url: '/homeowners-insurance/', name: 'Home Insurance', icon: '🏠' },
  { url: '/life-insurance/', name: 'Life Insurance', icon: '💰' },
  { url: '/disability-insurance/', name: 'Disability Insurance', icon: '🦽' }
];

const currentYear = new Date().getFullYear();

// CDN Configuration  
const CDN_BASE = import.meta.env.CDN_BASE_URL || '';
const USE_CDN = import.meta.env.USE_CDN === 'true' && import.meta.env.PROD;
---

<!DOCTYPE html>
<html lang="en" class="h-full" itemscope itemtype="http://schema.org/WebSite">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    
    <!-- Performance Optimizer Component -->
    <script is:inline>
      // Critical inline theme script - prevents FOUC
      (function() {
        const theme = localStorage.getItem('theme') || 
                     (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
    
    <!-- Enhanced Resource Hints for Speed Index optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    
    <!-- DNS Prefetch for external resources loaded later -->
    <link rel="dns-prefetch" href="//pagead2.googlesyndication.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    
    <!-- Critical resource preloading for LCP optimization -->
    <link rel="preload" href="/favicon.svg" as="image" type="image/svg+xml" />
    <link rel="preload" href="https://fonts.gstatic.com/s/inter/v12/UcCo3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Prefetch next-page resources -->
    <link rel="prefetch" href="/about/" />
    <link rel="prefetch" href="/tools/" />
    
    <!-- Preload critical CSS for immediate application -->
    <link rel="preload" href="/assets/critical.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="/assets/critical.css" /></noscript>
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={url} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, SITE.URL).toString()} />
    <meta property="og:url" content={url} />
    <meta property="og:type" content={type} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={SITE.SOCIAL.TWITTER} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(image, SITE.URL).toString()} />
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico" sizes="48x48" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Schema.org -->
    {schema && Array.isArray(schema) && schema.length > 0 ? (
      <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    ) : (
      <script type="application/ld+json" set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': type === 'article' ? 'Article' : 'WebSite',
        'name': title,
        'headline': title,
        'description': description,
        'image': new URL(image, SITE.URL).toString(),
        'url': url,
        'datePublished': publishedDate,
        'dateModified': modifiedDate || publishedDate,
        'author': author && author.name ? {
          '@type': 'Person',
          'name': author.name,
          'url': author.url
        } : undefined,
        'publisher': {
          '@type': 'Organization',
          'name': SITE.NAME,
          'url': SITE.URL,
          'logo': {
            '@type': 'ImageObject',
            'url': new URL('/logo.svg', SITE.URL).toString()
          }
        },
        'mainEntityOfPage': {
          '@type': 'WebPage',
          '@id': url
        },
        'articleSection': category,
        'keywords': tags && tags.length > 0 ? tags.join(',') : undefined
      })} />
    )}
    
    <!-- ULTRA-CRITICAL INLINE CSS - Zero render blocking - ACTUAL USED CLASSES -->
    <style is:inline>
      /* CRITICAL PATH CSS - Above the fold only */
      *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
      html{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;-webkit-text-size-adjust:100%;scroll-behavior:smooth;text-rendering:optimizeSpeed}
      body{background:#fff;color:#111827;font-size:16px;font-display:swap}
      .dark body{background:#111827;color:#f9fafb}
      
      /* LAYOUT PREVENTION - Zero CLS - ACTUAL LAYOUT */
      .min-h-full{min-height:100vh}
      .mx-auto{margin:0 auto}
      .max-w-7xl{max-width:80rem}
      .px-4{padding-left:1rem;padding-right:1rem}
      .py-10{padding-top:2.5rem;padding-bottom:2.5rem}
      .py-8{padding-top:2rem;padding-bottom:2rem}
      .py-12{padding-top:3rem;padding-bottom:3rem}
      .py-4{padding-top:1rem;padding-bottom:1rem}
      .py-3{padding-top:0.75rem;padding-bottom:0.75rem}
      .py-1{padding-top:0.25rem;padding-bottom:0.25rem}
      .px-2{padding-left:0.5rem;padding-right:0.5rem}
      .p-4{padding:1rem}
      .p-6{padding:1.5rem}
      
      /* GRID SYSTEM - ACTUAL USAGE */
      .grid{display:grid}
      .grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}
      .gap-8{gap:2rem}
      .gap-4{gap:1rem}
      .gap-2{gap:0.5rem}
      
      /* FLEXBOX - ACTUAL USAGE */
      .flex{display:flex}
      .flex-col{flex-direction:column}
      .items-center{align-items:center}
      .justify-between{justify-content:space-between}
      .justify-center{justify-content:center}
      .space-y-6>*+*{margin-top:1.5rem}
      .space-y-2>*+*{margin-top:0.5rem}
      .space-y-1>*+*{margin-top:0.25rem}
      
      /* POSITIONING - ACTUAL USAGE */
      .sticky{position:sticky}
      .relative{position:relative}
      .absolute{position:absolute}
      .top-8{top:2rem}
      .top-0{top:0}
      .order-2{order:2}
      .order-1{order:1}
      .z-50{z-index:50}
      .z-40{z-index:40}
      .z-30{z-index:30}
      .z-10{z-index:10}
      
      /* CALCULATOR CRITICAL STYLES - Fixed heights prevent CLS */
      .calculator-container{min-height:800px;contain:layout style;background:#fff;border-radius:0.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);padding:1.5rem}
      .dark .calculator-container{background:#374151}
      
      /* FORM ELEMENTS - Fixed heights, improved contrast, focus states */
      input,select,button{height:48px;min-height:48px;line-height:1.5;padding:0.75rem;border:1px solid #d1d5db;border-radius:0.5rem;width:100%;transition:border-color 0.15s ease}
      input:focus,select:focus,button:focus{outline:2px solid #3b82f6;outline-offset:2px;border-color:#3b82f6}
      .dark input,.dark select,.dark button{background:#374151;border-color:#6b7280;color:#f9fafb}
      .dark input:focus,.dark select:focus,.dark button:focus{border-color:#60a5fa}
      
      /* ACCESSIBLE BUTTON STYLES - Touch targets 44px minimum */
      button{min-height:52px;min-width:44px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
      .btn-primary{background:#1d4ed8;color:#fff;border:none;padding:1rem 1.5rem}
      .btn-primary:hover{background:#1e40af}
      .btn-primary:focus{box-shadow:0 0 0 3px rgba(59,130,246,0.5)}
      
      /* IMPROVED CONTRAST - WCAG AA compliance */
      .text-gray-600{color:#4b5563!important}
      .dark .text-gray-600{color:#9ca3af!important}
      .text-gray-500{color:#6b7280!important}
      .dark .text-gray-500{color:#a1a1aa!important}
      label{font-weight:500;color:#374151}
      .dark label{color:#f3f4f6}
      
      /* BACKGROUNDS - ACTUAL USAGE */
      .bg-white{background:#fff}
      .bg-gray-800{background:#1f2937}
      .bg-gradient-to-br{background:linear-gradient(to bottom right,var(--tw-gradient-stops))}
      .from-blue-50{--tw-gradient-from:#eff6ff;--tw-gradient-to:#eff6ff00;--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}
      .to-indigo-50{--tw-gradient-to:#eef2ff}
      .from-blue-900\/20{--tw-gradient-from:rgb(30 58 138 / 0.2);--tw-gradient-to:rgb(30 58 138 / 0);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}
      .to-indigo-900\/20{--tw-gradient-to:rgb(49 46 129 / 0.2)}
      
      /* TEXT COLORS - ACTUAL USAGE */
      .text-gray-900{color:#111827}
      .text-gray-600{color:#4b5563}
      .text-gray-500{color:#6b7280}
      .text-gray-400{color:#9ca3af}
      .text-white{color:#fff}
      .text-blue-600{color:#2563eb}
      .text-blue-700{color:#1d4ed8}
      .text-blue-800{color:#1e40af}
      .text-blue-900{color:#1e3a8a}
      .hover\\:text-blue-800:hover{color:#1e40af}
      .hover\\:text-blue-900:hover{color:#1e3a8a}
      .dark .text-white{color:#fff}
      .dark .text-gray-400{color:#9ca3af}
      
      /* BORDERS - ACTUAL USAGE */
      .border{border-width:1px}
      .border-blue-200{border-color:#dbeafe}
      .border-blue-700{border-color:#1d4ed8}
      .rounded-lg{border-radius:0.5rem}
      .rounded{border-radius:0.25rem}
      .dark .border-blue-700{border-color:#1d4ed8}
      
      /* SHADOWS - ACTUAL USAGE */
      .shadow-lg{box-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1),0 4px 6px -4px rgb(0 0 0 / 0.1)}
      
      /* TYPOGRAPHY - ACTUAL USAGE */
      .font-bold{font-weight:700}
      .font-semibold{font-weight:600}
      .text-sm{font-size:0.875rem;line-height:1.25rem}
      .text-xs{font-size:0.75rem;line-height:1rem}
      
      /* DISPLAY - ACTUAL USAGE */
      .block{display:block}
      .inline-block{display:inline-block}
      .hidden{display:none!important}
      
      /* MARGINS - ACTUAL USAGE */
      .mb-3{margin-bottom:0.75rem}
      .mb-2{margin-bottom:0.5rem}
      .mb-1{margin-bottom:0.25rem}
      .text-center{text-align:center}
      
      /* HOVER EFFECTS - ACTUAL USAGE */
      .hover\\:bg-blue-50:hover{background:#eff6ff}
      .hover\\:bg-blue-900\/20:hover{background:rgb(30 58 138 / 0.2)}
      .dark .hover\\:bg-blue-900\/20:hover{background:rgb(30 58 138 / 0.2)}
      
      /* RESPONSIVE - LG BREAKPOINT */
      @media (min-width:1024px){
        .lg\\:grid-cols-12{grid-template-columns:repeat(12,minmax(0,1fr))}
        .lg\\:col-span-2{grid-column:span 2/span 2}
        .lg\\:col-span-8{grid-column:span 8/span 8}
        .lg\\:order-1{order:1}
        .lg\\:order-2{order:2}
      }
      
      /* ADDITIONAL RESPONSIVE */
      @media (min-width:768px){
        .md\\:flex{display:flex}
        .md\\:hidden{display:none}
        .md\\:py-3{padding-top:.75rem;padding-bottom:.75rem}
        .md\\:text-6xl{font-size:3.75rem;line-height:1}
      }
      @media (min-width:1024px){
        .lg\\:text-7xl{font-size:4.5rem;line-height:1}
      }
    </style>
    
    <!-- ULTRA-OPTIMIZED ASYNC SCRIPT - Zero main-thread blocking -->
    <script is:inline>
      // Chunked task execution to prevent TBT
      function runChunked(tasks, chunkSize = 3) {
        return new Promise((resolve) => {
          let i = 0;
          function processChunk() {
            const end = Math.min(i + chunkSize, tasks.length);
            for (; i < end; i++) {
              if (typeof tasks[i] === 'function') tasks[i]();
            }
            if (i < tasks.length) {
              setTimeout(processChunk, 0);
            } else {
              resolve();
            }
          }
          processChunk();
        });
      }
      
      // Ultra-critical CSS loader
      function loadCSS(href, media) {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'style';
        link.href = href;
        link.media = media || 'all';
        link.onload = function() { this.rel = 'stylesheet'; };
        document.head.appendChild(link);
      }
      
      // Critical theme with zero blocking
      (function() {
        const theme = localStorage.theme || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        if (theme === 'dark') document.documentElement.classList.add('dark');
      })();
      
      // Load CSS chunks after FCP
      requestIdleCallback ? requestIdleCallback(function() {
        loadCSS('/assets/css/main.css');
        loadCSS('/assets/css/optimized-fonts.css');
      }, {timeout: 2000}) : setTimeout(function() {
        loadCSS('/assets/css/main.css');
        loadCSS('/assets/css/optimized-fonts.css');
      }, 50);
    </script>
    
    <!-- ASYNC SCRIPT LOADER - Zero render blocking -->
    <script is:inline define:vars={{ USE_CDN, CDN_BASE }}>
      // Post-load initialization with task chunking
      function initAfterInteractive() {
        const tasks = [
          function() {
            const script = document.createElement('script');
            script.src = (USE_CDN && CDN_BASE ? CDN_BASE : '') + '/scripts/enhancedThemeScript.js';
            script.async = true;
            document.head.appendChild(script);
          },
          function() {
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.register((USE_CDN && CDN_BASE ? CDN_BASE : '') + '/sw.js').catch(()=>{});
            }
          },
          function() {
            // Progressive image observer
            if ('IntersectionObserver' in window) {
              const obs = new IntersectionObserver((entries) => {
                entries.forEach((e) => {
                  if (e.isIntersecting && e.target.dataset.src) {
                    e.target.src = e.target.dataset.src;
                    obs.unobserve(e.target);
                  }
                });
              });
              document.querySelectorAll('img[data-src]').forEach((img) => obs.observe(img));
            }
          }
        ];
        
        // Execute tasks in chunks to prevent TBT
        runChunked(tasks, 1);
      }
      
      // Execute after page is interactive
      document.readyState === 'loading' 
        ? document.addEventListener('DOMContentLoaded', initAfterInteractive)
        : requestIdleCallback ? requestIdleCallback(initAfterInteractive, {timeout: 3000}) : setTimeout(initAfterInteractive, 100);
    </script>
    
    <!-- CSS Fallback for non-JS users -->
    <noscript>
      <link rel="stylesheet" href="/assets/css/main.css" />
      <link rel="stylesheet" href="/assets/css/optimized-fonts.css" />
    </noscript>
    
    <!-- ULTRA-CRITICAL RESOURCE HINTS - Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    <link rel="preload" href="/scripts/enhancedThemeScript.js" as="script">
    <link rel="preload" href="/api/rates/auto.json" as="fetch" crossorigin>
    
    <!-- CRITICAL INLINE PERFORMANCE MONITORING -->
    <script is:inline>
      // Ultra-minimal performance monitoring
      if ('PerformanceObserver' in window) {
        new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              // LCP tracking for optimization
              console.log('LCP:', entry.startTime);
            }
          }
        }).observe({entryTypes: ['largest-contentful-paint']});
      }
    </script>
    
    <!-- Enhanced Insurance Analytics Integration -->
    <EnhancedAnalytics />
  </head>
  <body class="min-h-full flex flex-col bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100" role="document">
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-blue-600 text-white px-4 py-2 rounded-md z-50 font-medium">Skip to main content</a>
    
    <header class="border-b bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 sticky top-0 z-50 dark:bg-gray-900/80 dark:border-gray-700" role="banner">
      <div class="mx-auto w-full max-w-[var(--max-w)] px-4 py-4 md:py-3">
        <!-- Desktop & Mobile Header -->
        <div class="flex items-center justify-between">
          <!-- Brand -->
          <div role="banner" aria-label="Site brand">
            <a href="/" class="font-bold text-xl text-gray-900 dark:text-gray-100 no-underline hover:text-blue-600 dark:hover:text-blue-400 transition-colors" aria-label="Go to homepage">
              <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent" aria-label="Sezarr Insurance">Sezarr</span>
            </a>
          </div>
          
          <!-- Desktop Navigation -->
          <nav class="hidden md:flex gap-6 text-sm items-center" role="navigation" aria-label="Main navigation">
            <ul class="flex items-center gap-6 list-none" role="list">
              <li role="listitem">
                <a href="/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/' ? 'page' : undefined}>Home</a>
              </li>
              <!-- Tools Dropdown -->
              <li role="listitem" class="relative group">
                <button 
                  type="button"
                  class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="tools-menu"
                >
                  Tools
                  <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div 
                  id="tools-menu"
                  class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                  role="menu"
                  aria-labelledby="tools-button"
                >
                  <div class="py-2">
                    {toolsData.map(tool => (
                      <a href={tool.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                        <span class="mr-3 text-lg">{tool.icon}</span>
                        {tool.name}
                      </a>
                    ))}
                  </div>
                </div>
              </li>
              <!-- Insurance Dropdown -->
              <li role="listitem" class="relative group">
                <button 
                  type="button"
                  class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="insurance-menu"
                >
                  Insurance
                  <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div 
                  id="insurance-menu"
                  class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                  role="menu"
                  aria-labelledby="insurance-button"
                >
                  <div class="py-2">
                    {insuranceData.map(insurance => (
                      <a href={insurance.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                        <span class="mr-3 text-lg">{insurance.icon}</span>
                        {insurance.name}
                      </a>
                    ))}
                  </div>
                </div>
              </li>
              <!-- Blog Dropdown -->
              <li role="listitem" class="relative group">
                <button 
                  type="button"
                  class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center gap-1 group-hover:text-blue-600"
                  aria-expanded="false"
                  aria-haspopup="true"
                  aria-controls="blog-menu"
                >
                  Blog
                  <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                
                <!-- Dropdown Menu -->
                <div 
                  id="blog-menu"
                  class="absolute top-full left-0 mt-1 w-56 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50"
                  role="menu"
                  aria-labelledby="blog-button"
                >
                  <div class="py-2">
                    <a href="/blog/" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                      <span class="mr-3 text-lg">📝</span>
                      Blog Home
                    </a>
                    <a href="/posts/" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                      <span class="mr-3 text-lg">📚</span>
                      All Articles
                    </a>
                    <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                    {blogCategories.map(category => (
                      <a href={category.url} class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" role="menuitem">
                        <span class="mr-3 text-lg">{category.icon}</span>
                        {category.name}
                      </a>
                    ))}
                  </div>
                </div>
              </li>
              <!-- Search Bar -->
              <li role="listitem" class="relative">
                <form action="/search/" method="GET" class="relative">
                  <input 
                    type="search" 
                    name="q" 
                    id="nav-search"
                    placeholder="Search..." 
                    class="w-48 px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    aria-label="Search site"
                    autocomplete="off"
                  />
                  <button 
                    type="submit"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 focus:outline-none focus:text-blue-600"
                    aria-label="Submit search"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </button>
                  
                  <!-- Search Dropdown -->
                  <div 
                    id="nav-search-results"
                    class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50 max-h-80 overflow-y-auto"
                  >
                    <div id="nav-search-list" class="py-2">
                      <!-- Search results will be populated here -->
                    </div>
                  </div>
                </form>
              </li>
              <li role="listitem">
                <a href="/about/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/about/' ? 'page' : undefined}>About</a>
              </li>
              <li role="listitem">
                <a href="/contact/" class="hover:text-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-3 py-2 min-h-[44px] flex items-center" aria-current={currentPath === '/contact/' ? 'page' : undefined}>Contact</a>
              </li>
              <li role="listitem">
                <ThemeToggle />
              </li>
            </ul>
          </nav>

          <!-- Mobile Menu Button -->
          <div class="md:hidden flex items-center">
            <button 
              id="mobile-menu-button" 
              type="button" 
              class="p-3 rounded-md text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px] min-w-[44px] flex items-center justify-center" 
              aria-expanded="false"
              aria-controls="mobile-menu"
              aria-haspopup="true"
              aria-label="Toggle navigation menu"
            >
              <span class="sr-only">Toggle navigation menu</span>
              <svg 
                id="menu-icon-open" 
                class="block h-6 w-6" 
                fill="none" 
                viewBox="0 0 24 24" 
                stroke-width="1.5" 
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
              <svg 
                id="menu-icon-close" 
                class="hidden h-6 w-6" 
                fill="none" 
                viewBox="0 0 24 24" 
                stroke-width="1.5" 
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile Navigation Menu with Drawer Style -->
        <nav id="mobile-menu" class="md:hidden hidden mt-4 pb-4 border-t dark:border-gray-700" role="navigation" aria-label="Mobile navigation">
          <!-- Main Menu Level -->
          <div id="mobile-main-menu" class="pt-4 space-y-2">
            <section aria-labelledby="mobile-main-heading">
              <h2 id="mobile-main-heading" class="sr-only">Main Navigation</h2>
              <ul class="space-y-2 list-none" role="list">
                <li><a href="/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">🏠</span>
                  Home
                </a></li>
                
                <!-- Tools Menu Item -->
                <li>
                  <button 
                    type="button"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                    data-menu-trigger="tools"
                    aria-expanded="false"
                    aria-controls="tools-submenu"
                  >
                    <div class="flex items-center">
                      <span class="mr-3 text-lg">🧮</span>
                      Tools
                    </div>
                    <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </li>

                <!-- Insurance Menu Item -->
                <li>
                  <button 
                    type="button"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                    data-menu-trigger="insurance"
                    aria-expanded="false"
                    aria-controls="insurance-submenu"
                  >
                    <div class="flex items-center">
                      <span class="mr-3 text-lg">🛡️</span>
                      Insurance
                    </div>
                    <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </li>

                <!-- Blog Menu Item -->
                <li>
                  <button 
                    type="button"
                    class="w-full flex items-center justify-between px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]"
                    data-menu-trigger="blog"
                    aria-expanded="false"
                    aria-controls="blog-submenu"
                  >
                    <div class="flex items-center">
                      <span class="mr-3 text-lg">📝</span>
                      Blog
                    </div>
                    <svg class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </button>
                </li>
                
                <!-- Mobile Search Bar -->
                <li class="px-4">
                  <form action="/search/" method="GET" class="relative">
                    <input 
                      type="search" 
                      name="q" 
                      id="mobile-search"
                      placeholder="Search..." 
                      class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[44px]"
                      aria-label="Search site"
                      autocomplete="off"
                    />
                    <button 
                      type="submit"
                      class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 focus:outline-none focus:text-blue-600 min-w-[44px] min-h-[44px] flex items-center justify-center"
                      aria-label="Submit search"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                      </svg>
                    </button>
                    
                    <!-- Mobile Search Dropdown -->
                    <div 
                      id="mobile-search-results"
                      class="absolute top-full left-0 right-0 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg opacity-0 invisible transition-all duration-200 z-50 max-h-80 overflow-y-auto"
                    >
                      <div id="mobile-search-list" class="py-2">
                        <!-- Search results will be populated here -->
                      </div>
                    </div>
                  </form>
                </li>
                
                <li><a href="/about/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/about/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">ℹ️</span>
                  About
                </a></li>
                <li><a href="/contact/" class="block px-4 py-3 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px] flex items-center" aria-current={currentPath === '/contact/' ? 'page' : undefined}>
                  <span class="mr-3 text-lg">📞</span>
                  Contact
                </a></li>
                <li class="px-4 py-3">
                  <ThemeToggle />
                </li>
              </ul>
            </section>
          </div>

          <!-- Tools Submenu Drawer -->
          <div 
            id="tools-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="tools-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="tools"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="tools-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Tools</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {toolsData.map(tool => (
                  <li>
                    <a href={tool.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{tool.icon}</span>
                      {tool.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Insurance Submenu Drawer -->
          <div 
            id="insurance-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="insurance-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="insurance"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="insurance-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Insurance</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                {insuranceData.map(insurance => (
                  <li>
                    <a href={insurance.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{insurance.icon}</span>
                      {insurance.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Blog Submenu Drawer -->
          <div 
            id="blog-submenu" 
            class="absolute inset-0 bg-white dark:bg-gray-900 border-t dark:border-gray-700 translate-x-full transition-transform duration-300 ease-out z-10"
            role="menu"
            aria-labelledby="blog-submenu-title"
          >
            <div class="pt-4">
              <!-- Back Button -->
              <div class="flex items-center px-4 py-3 border-b dark:border-gray-700 mb-4">
                <button 
                  type="button"
                  class="flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors"
                  data-menu-back="blog"
                  aria-label="Go back to main menu"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Back
                </button>
                <h3 id="blog-submenu-title" class="ml-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Blog</h3>
              </div>
              
              <ul class="space-y-1" role="list">
                <li>
                  <a href="/blog/" class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                    <span class="mr-3 text-lg">📝</span>
                    Blog Home
                  </a>
                </li>
                <li>
                  <a href="/posts/" class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                    <span class="mr-3 text-lg">📚</span>
                    All Articles
                  </a>
                </li>
                <li class="border-t dark:border-gray-700 mt-2 pt-2">
                  <div class="px-4 py-2 text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Categories</div>
                </li>
                {blogCategories.map(category => (
                  <li>
                    <a href={category.url} class="flex items-center px-4 py-3 text-base text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors min-h-[44px]" role="menuitem">
                      <span class="mr-3 text-lg">{category.icon}</span>
                      {category.name}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </nav>
      </div>

      <!-- Mobile Menu with Drawer JavaScript -->
      <script is:inline>
        (function() {
          function initMobileMenu() {
            const menuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const openIcon = document.getElementById('menu-icon-open');
            const closeIcon = document.getElementById('menu-icon-close');
            const mainMenu = document.getElementById('mobile-main-menu');
            
            // Get all submenu elements
            const toolsSubmenu = document.getElementById('tools-submenu');
            const insuranceSubmenu = document.getElementById('insurance-submenu');
            const blogSubmenu = document.getElementById('blog-submenu');
            
            // Get all menu triggers
            const menuTriggers = document.querySelectorAll('[data-menu-trigger]');
            const backButtons = document.querySelectorAll('[data-menu-back]');
            
            if (!menuButton || !mobileMenu || !openIcon || !closeIcon) {
              return;
            }
            
            let isMenuOpen = false;
            let activeSubmenu = null;
            
            function toggleMenu() {
              isMenuOpen = !isMenuOpen;
              
              if (isMenuOpen) {
                mobileMenu.classList.remove('hidden');
                openIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
                menuButton.setAttribute('aria-expanded', 'true');
                
                // Ensure main menu is visible and all submenus are hidden
                if (mainMenu) {
                  mainMenu.style.transform = 'translateX(0)';
                }
                hideAllSubmenus();
              } else {
                mobileMenu.classList.add('hidden');
                openIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
                menuButton.setAttribute('aria-expanded', 'false');
                hideAllSubmenus();
                activeSubmenu = null;
              }
            }
            
            function hideAllSubmenus() {
              [toolsSubmenu, insuranceSubmenu, blogSubmenu].forEach(submenu => {
                if (submenu) {
                  submenu.style.transform = 'translateX(100%)';
                }
              });
              
              // Reset all menu trigger icons
              menuTriggers.forEach(trigger => {
                const icon = trigger.querySelector('svg');
                if (icon) {
                  icon.style.transform = 'rotate(0deg)';
                }
                trigger.setAttribute('aria-expanded', 'false');
              });
            }
            
            function showSubmenu(submenuType) {
              const submenuMap = {
                'tools': toolsSubmenu,
                'insurance': insuranceSubmenu,
                'blog': blogSubmenu
              };
              
              const submenu = submenuMap[submenuType];
              if (!submenu) return;
              
              // Hide all other submenus first
              Object.values(submenuMap).forEach(sub => {
                if (sub && sub !== submenu) {
                  sub.style.transform = 'translateX(100%)';
                }
              });
              
              // Show the selected submenu with slide-in animation
              submenu.style.transform = 'translateX(0)';
              activeSubmenu = submenuType;
              
              // Update the trigger icon
              const trigger = document.querySelector(`[data-menu-trigger="${submenuType}"]`);
              if (trigger) {
                const icon = trigger.querySelector('svg');
                if (icon) {
                  icon.style.transform = 'rotate(90deg)';
                }
                trigger.setAttribute('aria-expanded', 'true');
              }
            }
            
            function hideSubmenu() {
              if (activeSubmenu) {
                const submenuMap = {
                  'tools': toolsSubmenu,
                  'insurance': insuranceSubmenu,
                  'blog': blogSubmenu
                };
                
                const submenu = submenuMap[activeSubmenu];
                if (submenu) {
                  submenu.style.transform = 'translateX(100%)';
                }
                
                // Reset the trigger icon
                const trigger = document.querySelector(`[data-menu-trigger="${activeSubmenu}"]`);
                if (trigger) {
                  const icon = trigger.querySelector('svg');
                  if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                  }
                  trigger.setAttribute('aria-expanded', 'false');
                }
                
                activeSubmenu = null;
              }
            }
            
            // Main menu toggle
            menuButton.addEventListener('click', toggleMenu);
            
            // Menu trigger buttons
            menuTriggers.forEach(trigger => {
              trigger.addEventListener('click', (e) => {
                e.preventDefault();
                const submenuType = trigger.getAttribute('data-menu-trigger');
                if (activeSubmenu === submenuType) {
                  hideSubmenu();
                } else {
                  showSubmenu(submenuType);
                }
              });
            });
            
            // Back buttons
            backButtons.forEach(button => {
              button.addEventListener('click', (e) => {
                e.preventDefault();
                hideSubmenu();
              });
            });
            
            // Close menu when clicking on a link
            const mobileLinks = mobileMenu.querySelectorAll('a:not([data-menu-trigger]):not([data-menu-back])');
            mobileLinks.forEach(link => {
              link.addEventListener('click', () => {
                if (isMenuOpen) {
                  toggleMenu();
                }
              });
            });
            
            // Close menu on escape key
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && isMenuOpen) {
                if (activeSubmenu) {
                  hideSubmenu();
                } else {
                  toggleMenu();
                }
              }
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
              if (isMenuOpen && !menuButton.contains(e.target) && !mobileMenu.contains(e.target)) {
                toggleMenu();
              }
            });
            
            // Handle mobile menu positioning
            function updateMobileMenuPosition() {
              if (mobileMenu) {
                const rect = mobileMenu.getBoundingClientRect();
                [toolsSubmenu, insuranceSubmenu, blogSubmenu].forEach(submenu => {
                  if (submenu) {
                    submenu.style.top = '0';
                    submenu.style.left = '0';
                    submenu.style.right = '0';
                    submenu.style.bottom = '0';
                  }
                });
              }
            }
            
            // Update position on resize
            window.addEventListener('resize', updateMobileMenuPosition);
            updateMobileMenuPosition();
          }
          
          // Initialize when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobileMenu);
          } else {
            initMobileMenu();
          }
        })();
      </script>
      
      <!-- Search Functionality -->
      <script is:inline define:vars={{ searchData: allPosts.map(p => ({ 
        slug: p.slug, 
        title: p.data.title, 
        description: p.data.description,
        category: p.data.category
      })) }}>
        (function() {
          function initSearch() {
            const navSearch = document.getElementById('nav-search');
            const navResults = document.getElementById('nav-search-results');
            const navList = document.getElementById('nav-search-list');
            
            const mobileSearch = document.getElementById('mobile-search');
            const mobileResults = document.getElementById('mobile-search-results');
            const mobileList = document.getElementById('mobile-search-list');
            
            if (!navSearch || !mobileSearch) return;
            
            function renderResults(items, listElement, resultsElement) {
              if (items.length === 0) {
                resultsElement.classList.add('opacity-0', 'invisible');
                return;
              }
              
              const html = items.slice(0, 5).map(item => `
                <a href="/posts/${item.slug}/" class="flex items-start px-4 py-3 hover:bg-blue-50 dark:hover:bg-blue-900/20 border-b border-gray-100 dark:border-gray-600 last:border-b-0 transition-colors">
                  <div class="flex-1">
                    <div class="font-semibold text-gray-900 dark:text-gray-100 text-sm mb-1">${item.title}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${item.description}</div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-1 capitalize">${item.category} Insurance</div>
                  </div>
                </a>
              `).join('');
              
              if (items.length > 5) {
                listElement.innerHTML = html + `
                  <div class="px-4 py-2 text-center">
                    <a href="/search/?q=${encodeURIComponent(navSearch.value || mobileSearch.value)}" class="text-blue-600 dark:text-blue-400 text-sm hover:underline">
                      View all ${items.length} results →
                    </a>
                  </div>
                `;
              } else {
                listElement.innerHTML = html;
              }
              
              resultsElement.classList.remove('opacity-0', 'invisible');
            }
            
            function performSearch(query) {
              if (!query || query.length < 2) {
                navResults.classList.add('opacity-0', 'invisible');
                mobileResults.classList.add('opacity-0', 'invisible');
                return;
              }
              
              const searchTerm = query.toLowerCase();
              const results = searchData.filter(item => 
                item.title.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
              ).sort((a, b) => {
                // Prioritize title matches
                const aTitleMatch = a.title.toLowerCase().includes(searchTerm);
                const bTitleMatch = b.title.toLowerCase().includes(searchTerm);
                if (aTitleMatch && !bTitleMatch) return -1;
                if (!aTitleMatch && bTitleMatch) return 1;
                return 0;
              });
              
              renderResults(results, navList, navResults);
              renderResults(results, mobileList, mobileResults);
            }
            
            // Desktop search
            navSearch.addEventListener('input', (e) => {
              performSearch(e.target.value);
            });
            
            navSearch.addEventListener('focus', () => {
              if (navSearch.value.length >= 2) {
                performSearch(navSearch.value);
              }
            });
            
            // Mobile search  
            mobileSearch.addEventListener('input', (e) => {
              performSearch(e.target.value);
            });
            
            mobileSearch.addEventListener('focus', () => {
              if (mobileSearch.value.length >= 2) {
                performSearch(mobileSearch.value);
              }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
              if (!navSearch.contains(e.target) && !navResults.contains(e.target)) {
                navResults.classList.add('opacity-0', 'invisible');
              }
              if (!mobileSearch.contains(e.target) && !mobileResults.contains(e.target)) {
                mobileResults.classList.add('opacity-0', 'invisible');
              }
            });
            
            // Close on escape
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape') {
                navResults.classList.add('opacity-0', 'invisible');
                mobileResults.classList.add('opacity-0', 'invisible');
              }
            });
          }
          
          // Initialize when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSearch);
          } else {
            initSearch();
          }
        })();
      </script>
    </header>
    
    <main id="main" class="flex-1" role="main">
      <div class="main-content">
        <div class="mx-auto w-full max-w-[var(--max-w)] px-4">
        </div>
        <slot />
      </div>
    </main>
    
    <footer class="border-t mt-12 dark:border-gray-700" role="contentinfo" aria-labelledby="footer-heading">
      <h2 id="footer-heading" class="sr-only">Footer</h2>
      <div class="mx-auto w-full max-w-[var(--max-w)] px-4 py-8 grid md:grid-cols-4 gap-6 text-sm text-gray-600 dark:text-gray-400">
        <section aria-labelledby="footer-about">
          <h3 id="footer-about" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">{SITE.NAME}</h3>
          <p>Smart insurance decisions made simple. We may earn from affiliate links. Not financial advice.</p>
        </section>
        <nav aria-labelledby="footer-legal">
          <h3 id="footer-legal" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Legal</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/privacy/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/privacy/' ? 'page' : undefined}>Privacy Policy</a></li>
            <li><a href="/terms/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/terms/' ? 'page' : undefined}>Terms</a></li>
            <li><a href="/disclaimer/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/disclaimer/' ? 'page' : undefined}>Disclaimer</a></li>
            <li><a href="/affiliate-disclosure/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/affiliate-disclosure/' ? 'page' : undefined}>Affiliate Disclosure</a></li>
          </ul>
        </nav>
        <nav aria-labelledby="footer-categories">
          <h3 id="footer-categories" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Categories</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/auto-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/auto-insurance/' ? 'page' : undefined}>Auto Insurance</a></li>
            <li><a href="/health-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/health-insurance/' ? 'page' : undefined}>Health Insurance</a></li>
            <li><a href="/homeowners-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/homeowners-insurance/' ? 'page' : undefined}>Homeowners Insurance</a></li>
            <li><a href="/life-insurance/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/life-insurance/' ? 'page' : undefined}>Life Insurance</a></li>
          </ul>
        </nav>
        <nav aria-labelledby="footer-connect">
          <h3 id="footer-connect" class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Connect</h3>
          <ul class="space-y-1 list-none" role="list">
            <li><a href="/contact/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/contact/' ? 'page' : undefined}>Contact</a></li>
            <li><a href="/about/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" aria-current={url === '/about/' ? 'page' : undefined}>About Us</a></li>
            <li><a href="/sitemap-index.xml" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1">Sitemap</a></li>
          </ul>
        </nav>
      </div>
      <div class="text-center text-xs text-gray-500 dark:text-gray-400 py-4 border-t dark:border-gray-700">
        <small>© {currentYear} {SITE.NAME}. All rights reserved.</small>
      </div>
    </footer>
  </body>
</html>